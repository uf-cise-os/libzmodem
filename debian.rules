#!/usr/bin/make -f

# Package name
PKG := lrzsz

# Package version
VER := 0.12a

# Package revision
DEB := 4

# Top directory of pre-deb hierarchy
TMP := $(shell pwd)/tmp

# Get the architecture for the binary
ARC := $(shell dpkg --print-architecture)
	
# Temporary directories
TMPDIRS := $(PKG)-src \
	$(TMP) \
	$(TMP)/DEBIAN \
	$(TMP)/usr/bin \
	$(TMP)/usr/doc/copyright \
	$(TMP)/usr/man/man1

# All of our targets are just actions
.PHONY: all build binary source diff

# Perform all important actions by default
all: binary source diff

# Makes a binary package.
build:
	make linux

# Makes a binary package.
binary: build $(TMPDIRS)
	install -o root -g root -m 755 -s lrz $(TMP)/usr/bin/rz
	install -o root -g root -m 755 -s lsz $(TMP)/usr/bin/sz
	install -o root -g root -m 644 lrz.1 $(TMP)/usr/man/man1/rz.1
	install -o root -g root -m 644 lsz.1 $(TMP)/usr/man/man1/sz.1
	( cd $(TMP)/usr/bin && ln -sf rz rb && ln -sf rz rx )
	( cd $(TMP)/usr/bin && ln -sf sz sb && ln -sf sz sx )
	( cd $(TMP)/usr/man/man1 && ln -sf rz.1 rb.1 && ln -sf rz.1 rx.1 )
	( cd $(TMP)/usr/man/man1 && ln -sf sz.1 sb.1 && ln -sf sz.1 sx.1 )
	install -o root -g root -m 644 debian.copyright $(TMP)/usr/doc/copyright/$(PKG)
	sed -e 's/=V/$(VER)-$(DEB)/' -e 's/=A/$(ARC)/' < debian.control > $(TMP)/DEBIAN/control
	chmod 644 $(TMP)/DEBIAN/control
	dpkg --build $(TMP)
	mv $(TMP).deb ../$(PKG)-$(VER)-$(DEB).$(ARC).deb

# Creates temporary directory hierarchy
$(TMPDIRS):
	install -d -g root -o root -m 755 $@
	chmod g-s $@

# Undoes the effect of `make -f debian.rules build'.
clean:
	make clean
	-rm -rf $(TMP) *~

# Makes a context diff.
diff: 
	cvs rdiff -u -r DIST debian/$(PKG) | gzip -9f > ../$(PKG)-$(VER)-$(DEB).diff.gz

# Makes a source package.
source:
	cvs export -d $(PKG)-src/$(PKG)-$(VER) -D now debian/$(PKG)
	cd $(PKG)-src && tar cf - $(PKG)-$(VER) | gzip -9f > ../../$(PKG)-$(VER)-$(DEB).tar.gz
	rm -rf $(PKG)-src
